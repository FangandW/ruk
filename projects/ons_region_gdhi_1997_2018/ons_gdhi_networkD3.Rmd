---
title: "networkD3 Sankey"
author: "NearAndDistant"
date: "21/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Grab ONS Gross Data from GitHub (Script in Repository)

##### Primary resources
0: Operating surplus
1: Mixed income
2: Compensation of employees
3: Property income, received

##### Primary uses
4: Property income, paid

##### Secondary resources
5: Social benefits received
6: Other current transfers, received

##### Secondary uses
7: Current taxes on income, wealth etc
8: Social contributions, paid
9: Other current transfers, paid

##### GDHI
10: Gross Disposable Income

```{r}
library(tidyverse)

# you can see the primary script to grab this at https://raw.githubusercontent.com/NearAndDistant/ruk/main/data_scripts/ons_gross_income_1997_to_2018/
ons_gdhi_components_97_18_raw <-
read_csv("https://raw.githubusercontent.com/NearAndDistant/ruk/main/data_scripts/ons_gdhi_components/ons_gdhi_components_97_18.csv")

```

##### Grabs NUTS1
```{r}

ons_gdhi_NUTS1 <-
ons_gdhi_components_97_18_raw %>%
  filter(`NUTS level` == "NUTS1") %>% # NUTS1 level is regions
  janitor::clean_names(numerals = "left") %>%
  pivot_longer(cols = starts_with("x") , names_to = "year" , values_to = "value") %>%
  mutate(year = str_remove(year , "x"),
         year = as.numeric(year),
         region_name = str_to_title(region_name)) %>%
  # clean long names
  mutate(region_name = if_else(region_name == "Yorkshire And The Humber", "Yorkshire", region_name)) %>%
  mutate(transaction = if_else(transaction == "Imputed social contributions/Social benefits received" , "Social benefits received", transaction)) %>%
  mutate(transaction = if_else(transaction == "Social contributions/Social benefits paid" , "Social contributions, paid", transaction)) %>%
  # filter out unecessary transactions i.e. totals or balances
  mutate(transaction_code = if_else(transaction == "Primary resources total" , "PRT", transaction_code)) %>% # so we keep this as a flow node
  mutate(value = if_else(transaction == "Gross Disposable Income" , NA_real_, value)) %>% # so we keep this as a flow node
  drop_na(transaction_code) %>% # NAs are just total rows in the ONS Excel file
  filter(year == 2018) %>%
  filter(region_name == "North East" | region_name == "London") %>%
  select(-year, -nuts_level, -nuts_code, -transaction_code) %>%
  # balancing out financials: as the flow diagram needs to know what is left over after "secondary payments" are mad (taxes etc)
  #we have to calculate their subtraction from Balance of Payments so that Gross Dispo
  pivot_wider(id_cols = c(region_name:transaction), names_from = "transaction", values_from = "value") %>%
  mutate(`Balance of primary incomes` = `Balance of primary incomes` - `Current taxes on income, wealth etc` - `Social contributions, paid` - `Other current transfers, paid`) %>%
  pivot_longer(cols = c(`Operating surplus`:`Gross Disposable Income`), names_to = "transaction" , values_to = "value")


```

#### Adding Groups
source = as.integer(c(0,1,2,3,4,4, 6, 7,8,6, 6, 6,12)),
target = as.integer(c(4,4,4,4,6,5,12,12,12,9,10,11,12)),

```{r}
ons_gdhi_NUTS1 <-
ons_gdhi_NUTS1 %>%
mutate(
group = 
case_when(
transaction == "Operating surplus"                   ~ "Income",
transaction == "Mixed income"                        ~ "Income",
transaction == "Compensation of employees"           ~ "Income",
transaction == "Property income, received"           ~ "Income",
transaction == "Primary resources total"             ~ "Income_Total",
transaction == "Property income, paid"               ~ "Rent",
transaction == "Balance of primary incomes"          ~ "Rent",
transaction == "Social benefits received"            ~ "Benefits",
transaction == "Other current transfers, received"   ~ "Benefits",
transaction == "Current taxes on income, wealth etc" ~ "Taxes",
transaction == "Social contributions, paid"          ~ "Taxes",
transaction == "Other current transfers, paid"       ~ "Taxes",
transaction == "Gross Disposable Income"             ~ "Disposable"),
source = 
case_when(
transaction == "Operating surplus"                   ~ "Operating surplus",
transaction == "Mixed income"                        ~ "Mixed income",
transaction == "Compensation of employees"           ~ "Compensation of employees",
transaction == "Property income, received"           ~ "Property income, received",
transaction == "Primary resources total"             ~ "Primary resources total",
transaction == "Property income, paid"               ~ "Primary resources total",
transaction == "Balance of primary incomes"          ~ "Balance of primary incomes",
transaction == "Social benefits received"            ~ "Social benefits received",
transaction == "Other current transfers, received"   ~ "Other current transfers, received",
transaction == "Current taxes on income, wealth etc" ~ "Balance of primary incomes",
transaction == "Social contributions, paid"          ~ "Balance of primary incomes",
transaction == "Other current transfers, paid"       ~ "Balance of primary incomes",
transaction == "Gross Disposable Income"             ~ "Balance of primary incomes"),
target = 
case_when(
transaction  == "Operating surplus"                   ~ "Primary resources total",
transaction  == "Mixed income"                        ~ "Primary resources total",
transaction  == "Compensation of employees"           ~ "Primary resources total",
transaction  == "Property income, received"           ~ "Primary resources total",
transaction  == "Primary resources total"             ~ "Balance of primary incomes",
transaction  == "Property income, paid"               ~ "Property income, paid",
transaction  == "Balance of primary incomes"          ~ "Gross Disposable Income",
transaction  == "Social benefits received"            ~ "Gross Disposable Income",
transaction  == "Other current transfers, received"   ~ "Gross Disposable Income",
transaction  == "Current taxes on income, wealth etc" ~ "Current taxes on income, wealth etc",
transaction  == "Social contributions, paid"          ~ "Social contributions, paid",
transaction  == "Other current transfers, paid"       ~ "Other current transfers, paid",
transaction  == "Gross Disposable Income"             ~ "Gross Disposable Income")) %>%
select(region_name , group , transaction , source , target , value)

```

#### {networkD3}
```{r}
library(networkD3)

nd3_gdhi <- 
list(
  nodes = data.frame(name   = unique(ons_gdhi_NUTS1$transaction),
                     group  = ons_gdhi_NUTS1$group),
  links = data.frame(source = ons_gdhi_NUTS1$source,
                     target = ons_gdhi_NUTS1$target,
                     group  = ons_gdhi_NUTS1$region_name,
                     value  = ons_gdhi_NUTS1$value))


sankeyNetwork(Links = nd3_gdhi$links, Nodes = nd3_gdhi$nodes , 
              Source = "source", Target = "target", Value = "value", NodeID = "name", NodeGroup = "group", LinkGroup = "group",
              units = "Â£", fontSize = 12, nodeWidth = 30, sinksRight = FALSE, iterations = 0)
```

##### Example
```{r}

myDf <- 
list(
  nodes = data.frame(name   =            c( "A", "B", "C", "D", "E",
                                            "V", "W", "X", "Y", "Z")),
  links = data.frame(source = as.integer(c(0, 1, 2, 4, 3, 4, 4)),
                     target = as.integer(c(7, 6, 5, 8, 5, 8, 9)),
                     value  =            c(1, 4, 1, 5, 1, 5, 3))
)

sankeyNetwork(Links = myDf$links, Nodes = myDf$nodes, 
              Source = "source", Target = "target", Value = "value", 
              NodeID = "name", units = "TWh", fontSize = 25, nodeWidth = 30, 
              fontFamily = "sans-serif", iterations = 0, sinksRight = FALSE)


```

######## GGSankey
```{r}

#### {ggsankey}
```{r}
library(ggsankey)
theme_set(theme_minimal())

# Make wide, make long, make Sankey all day long
long_nuts1 <-
make_long(wide_nuts1)

# plot ggsankey
nuts1_long %>%
  ggplot(aes(x = x, 
             next_x = next_x, 
             node = node, 
             next_node = next_node,
             fill = factor(node),
             label = node)) +
  geom_sankey(show.legend = FALSE) +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  theme_sankey(base_size = 18)

```

```

