---
title: "Mapping Gross Income"
author: "NearAndDistant"
date: "13/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Grab Boundaries from ONS
```{r}

library(tidyverse)
library(sf)
library(jsonlite)

#load geojson from url
uk_regions_boundaries <-
st_read('https://opendata.arcgis.com/datasets/01fd6b2d7600446d8af768005992f76a_3.geojson') %>%
  rename(name = nuts118nm) %>% 
  mutate(name = str_remove(name , " \\(England\\)"), 
         name = str_to_title(name))

```

#### Grab ONS Gross Data from GitHub (Script in Repository)
```{r}

ons_gross_income_1997_to_2018 <-
read_csv("https://raw.githubusercontent.com/NearAndDistant/ruk/main/data_scripts/ons_gross_income_1997_to_2018/ons_gross_income_1997_to_2018.csv")

```

##### Grabs NUTS1
```{r}

ons_gross_income_1997_to_2018_NUTS1 <-
ons_gross_income_1997_to_2018 %>%
  filter(`NUTS level` == "NUTS1") %>%
  janitor::clean_names(numerals = "left") %>%
  pivot_longer(cols = starts_with("x") , names_to = "year" , values_to = "gross_income") %>%
  mutate(year = str_remove(year , "x"),
         year = as.numeric(year),
         region_name = str_to_title(region_name))

```

##### Merging for Map
```{r}

uk_gross_1997_to_2018 <- 
uk_regions_boundaries %>%
  inner_join(ons_gross_income_1997_to_2018_NUTS1 , by = c(name = "region_name")) %>%
  mutate(name = if_else(name == "Yorkshire and The Humber", "Yorkshire", name))

```

###### Create UK Outline
```{r}
library(rnaturalearth)

uk      <- ne_countries(scale = "medium", returnclass = "sf", country = "United Kingdom")
ireland <- ne_countries(scale = "medium", returnclass = "sf", country = "Ireland")

```

##### Map
```{r}

plot_uk_gdhi_1997_2018 <-
uk_gross_1997_to_2018 %>%
  filter(year %in% c(1997,seq(2000,2015,5),2018)) %>%
  ggplot() +
  geom_sf(data = ireland, fill = "white" , color = "grey80") +
  geom_sf(aes(fill = gross_income), color = "white") +
  scale_fill_viridis_c(labels = scales::comma_format(accuracy = 1 , prefix = "£") , direction = -1) +
  coord_sf() +
  facet_wrap(~year, nrow = 1, strip.position = "bottom") +
  labs(title = "ONS Regional Average Gross Disposable Household Income (GDHI)" , 
       subtitle = '  GDHI is the amount of money that all of the individuals in the household have available for spending or saving after they have paid direct and indirect taxes and received any direct benefits.\n GDHI is a concept that is seen to reflect the “material welfare” of the household. Regional estimates are produced in current prices (which include the effects of inflation).',
       fill = "Average Gross Income") +
  ggthemes::theme_map() +
  theme(plot.background = element_rect(fill = "white" , color = "white"),
        plot.title = element_text(size = 24 , face = "bold" , hjust = 0.025, vjust = 2),
        plot.subtitle = element_text(size = 12 , hjust = 0.025 , vjust = 1),
        legend.position = c(0,0.85),
        legend.direction = "horizontal",
        legend.title = element_blank(),
        legend.key.width = unit(2.5, "cm"),
        strip.background = element_rect(fill = "white" , color = "white"),
        strip.text = element_text(size = 12 , face = "bold"),
        plot.margin = margin(0.1,0,10,0.1, unit = "cm"))

```

##### Regional Rate of Change
```{r}
theme_set(theme_minimal())

plot_region_gdhi_roc <-
ons_gross_income_1997_to_2018_NUTS1 %>%
  ggplot(aes(year , gross_income , color = gross_income, group = region_name)) +
  geom_line(show.legend = FALSE , size = 1.5) +
  scale_x_continuous(breaks = c(1997,seq(2000,2015,5),2018), limits = c(1997,2018), expand = c(0,0)) +
  scale_y_continuous(labels = scales::comma_format(accuracy = 1 , prefix = "£"), breaks = seq(0,250000,50000),
                     sec.axis = dup_axis(breaks = ons_gross_income_1997_to_2018_NUTS1$gross_income[which(ons_gross_income_1997_to_2018_NUTS1$year == 2018)],
                                         labels = ons_gross_income_1997_to_2018_NUTS1$region_name[which(ons_gross_income_1997_to_2018_NUTS1$year == 2018)],
                                         guide  = guide_axis(check.overlap = TRUE))) +
  scale_color_viridis_c(labels = scales::comma_format(accuracy = 1 , prefix = "£"), direction = -1) +
  labs(x = NULL , y = NULL) +
  theme(panel.grid.minor = element_blank(), 
        panel.grid.major.x = element_blank(), 
        axis.title.y.right = element_blank(), 
        axis.text.y.right = element_text(face = "bold"),
        axis.text.x = element_blank(),
        plot.margin = margin(0,0,0,2, unit = "cm"))

```

##### Panel
```{r}
library(cowplot)

ons_region_gdhi_1997_2018 <-
ggdraw(plot_uk_gdhi_1997_2018) +
  draw_plot(plot_region_gdhi_roc , height = 0.40) +
  theme(plot.background = element_rect(fill = "white" , color = "white"))

```

##### Saving
```{r}

dir.create(here::here("projects/ons_region_gdhi_1997_2018"))

ggsave(here::here("ons_region_gdhi_1997_2018.png"), dpi = 360, height = 10, width = 15)

```

