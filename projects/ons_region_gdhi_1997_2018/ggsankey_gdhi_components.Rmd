---
title: "NHS-R Sankey"
author: "NearAndDistant"
date: "22/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Grab ONS Gross Data from GitHub (Script in Repository)

##### Primary resources
0: Operating surplus
1: Mixed income
2: Compensation of employees
3: Property income, received

##### Primary uses
4: Property income, paid

##### Secondary resources
5: Social benefits received
6: Other current transfers, received

##### Secondary uses
7: Current taxes on income, wealth etc
8: Social contributions, paid
9: Other current transfers, paid

##### GDHI
10: Gross Disposable Income

```{r}
library(tidyverse)

# you can see the primary script to grab this at https://raw.githubusercontent.com/NearAndDistant/ruk/main/data_scripts/ons_gross_income_1997_to_2018/
ons_gdhi_components_97_18_raw <-
read_csv("https://raw.githubusercontent.com/NearAndDistant/ruk/main/data_scripts/ons_gdhi_components/ons_gdhi_components_97_18.csv")

```

##### Grabs NUTS1
```{r}

ons_gdhi_NUTS1 <-
ons_gdhi_components_97_18_raw %>%
  filter(`NUTS level` == "NUTS1") %>% # NUTS1 level is regions
  janitor::clean_names(numerals = "left") %>%
  pivot_longer(cols = starts_with("x") , names_to = "year" , values_to = "value") %>%
  mutate(year = str_remove(year , "x"),
         year = as.numeric(year),
         region_name = str_to_title(region_name)) %>%
  # clean long names
  mutate(region_name = if_else(region_name == "Yorkshire And The Humber", "Yorkshire", region_name)) %>%
  mutate(transaction = if_else(transaction == "Imputed social contributions/Social benefits received" , "Social benefits received", transaction)) %>%
  mutate(transaction = if_else(transaction == "Social contributions/Social benefits paid" , "Social contributions, paid", transaction)) %>%
  # filter out unecessary transactions i.e. totals or balances
  mutate(transaction_code = if_else(transaction == "Primary resources total" , "PRT", transaction_code)) %>% # so we keep this as a flow node
  mutate(value = if_else(transaction == "Gross Disposable Income" , NA_real_, value)) %>% # so we keep this as a flow node
  drop_na(transaction_code) %>% # NAs are just total rows in the ONS Excel file
  filter(year == 2018) %>%
  filter(region_name == "North East" | region_name == "London") %>%
  select(-year, -nuts_level, -nuts_code, -transaction_code) %>%
  # balancing out financials: as the flow diagram needs to know what is left over after "secondary payments" are mad (taxes etc)
  #we have to calculate their subtraction from Balance of Payments so that Gross Dispo
  pivot_wider(id_cols = c(region_name:transaction), names_from = "transaction", values_from = "value") %>%
  mutate(`Balance of primary incomes` = `Balance of primary incomes` - `Current taxes on income, wealth etc` - `Social contributions, paid` - `Other current transfers, paid`) %>%
  pivot_longer(cols = c(`Operating surplus`:`Gross Disposable Income`), names_to = "transaction" , values_to = "value")

```

##### Adding Group
```{r}
prep_NUTS1 <-
ons_gdhi_NUTS1 %>%
mutate(
group = 
case_when(
transaction == "Operating surplus"                   ~ "Income",
transaction == "Mixed income"                        ~ "Income",
transaction == "Compensation of employees"           ~ "Income",
transaction == "Property income, received"           ~ "Income",
transaction == "Primary resources total"             ~ "Income_Total",
transaction == "Property income, paid"               ~ "Rent",
transaction == "Balance of primary incomes"          ~ "Rent",
transaction == "Social benefits received"            ~ "Benefits",
transaction == "Other current transfers, received"   ~ "Benefits",
transaction == "Current taxes on income, wealth etc" ~ "Taxes",
transaction == "Social contributions, paid"          ~ "Taxes",
transaction == "Other current transfers, paid"       ~ "Taxes",
transaction == "Gross Disposable Income"             ~ "Disposable"),
source = 
case_when(
transaction == "Operating surplus"                   ~ paste(sep = ", ",region_name, "Operating surplus"),
transaction == "Mixed income"                        ~ paste(sep = ", ",region_name, "Mixed income"),
transaction == "Compensation of employees"           ~ paste(sep = ", ",region_name, "Compensation of employees"),
transaction == "Property income, received"           ~ paste(sep = ", ",region_name, "Property income, received"),
transaction == "Primary resources total"             ~ "Primary resources total",
transaction == "Property income, paid"               ~ "Primary resources total",
transaction == "Balance of primary incomes"          ~ "Balance of primary incomes",
transaction == "Social benefits received"            ~ "Social benefits received",
transaction == "Other current transfers, received"   ~ "Other current transfers, received",
transaction == "Current taxes on income, wealth etc" ~ "Balance of primary incomes",
transaction == "Social contributions, paid"          ~ "Balance of primary incomes",
transaction == "Other current transfers, paid"       ~ "Balance of primary incomes",
transaction == "Gross Disposable Income"             ~ "Balance of primary incomes"),
target = 
case_when(
transaction  == "Operating surplus"                   ~ "Primary resources total",
transaction  == "Mixed income"                        ~ "Primary resources total",
transaction  == "Compensation of employees"           ~ "Primary resources total",
transaction  == "Property income, received"           ~ "Primary resources total",
transaction  == "Primary resources total"             ~ "Balance of primary incomes",
transaction  == "Property income, paid"               ~ "Property income, paid",
transaction  == "Balance of primary incomes"          ~ "Gross Disposable Income",
transaction  == "Social benefits received"            ~ "Gross Disposable Income",
transaction  == "Other current transfers, received"   ~ "Gross Disposable Income",
transaction  == "Current taxes on income, wealth etc" ~ "Current taxes on income, wealth etc",
transaction  == "Social contributions, paid"          ~ "Social contributions, paid",
transaction  == "Other current transfers, paid"       ~ "Other current transfers, paid",
transaction  == "Gross Disposable Income"             ~ "Gross Disposable Income")) %>%
select(region_name , group, source , target , value) %>%
group_by(region_name)

# group indices 
prep_NUTS1$id <- paste0(group_indices(prep_NUTS1))

indexed_NUTS1 <-
prep_NUTS1 %>%
  group_by(region_name) %>%
  mutate(id2 = str_pad(5:17, width = 2, pad = "0")) %>%
  mutate(id = paste(id , id2, sep = ".")) %>%
  select(-id2) %>%
  select(id , everything()) %>%
  ungroup() %>%
  arrange(id)


```

##### Adding Regions
```{r}

income <- c("Operating surplus", "Mixed income" , "Compensation of employees" , "Property income, received")

regions <- 
  tibble(
    region_name = prep_NUTS1$region_name,
    group  = "Region",
    source = prep_NUTS1$region_name,
    target = prep_NUTS1$source,
    value  = prep_NUTS1$value) %>%
    group_by(source) %>%
    slice_head(n = 4)

# group_indices
regions$id <- group_indices(regions)

# id full
regions <- 
  regions %>% 
  group_by(region_name) %>%   
  mutate(id2 = str_pad(1:4, width = 2, pad = "0")) %>%
  mutate(id = paste(id , id2, sep = ".")) %>%
  select(-id2) %>%
  select(id , everything())

# join
full_nuts1 <-
  rbind(indexed_NUTS1 , regions) %>%
  arrange(id)

```

#### {networkD3}
```{r}
library(networkD3)

# Nodes
nodes <- 
  full_nuts1 %>%
  select(source , target) %>%
  pivot_longer(cols = c(source,target)) %>%
  select(-name) %>%
  distinct(value) %>%
  mutate(id = )


nd3_gdhi <- 
list(
  nodes = data.frame(name   =        nodes$value),
  links = data.frame(source =        full_nuts1$source,
                     target =        full_nuts1$target,
                     group  =        full_nuts1$region_name,
                     value  =        full_nuts1$value))


sankeyNetwork(Links = nd3_gdhi$links, Nodes = nd3_gdhi$nodes , 
              Source = "source", Target = "target", Value = "value", NodeID = "name", NodeGroup = "group", LinkGroup = "group",
              units = "Â£", fontSize = 12, nodeWidth = 30, sinksRight = FALSE, iterations = 0)
```



