---
title: "NHS-R Sankey"
author: "NearAndDistant"
date: "22/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Grab ONS Gross Data from GitHub (Script in Repository)

##### Primary resources
0: Operating surplus
1: Mixed income
2: Compensation of employees
3: Property income, received

##### Primary uses
4: Property income, paid

##### Secondary resources
5: Social benefits received
6: Other current transfers, received

##### Secondary uses
7: Current taxes on income, wealth etc
8: Social contributions, paid
9: Other current transfers, paid

##### GDHI
10: Gross Disposable Income

```{r}
library(tidyverse)

# you can see the primary script to grab this at https://raw.githubusercontent.com/NearAndDistant/ruk/main/data_scripts/ons_gross_income_1997_to_2018/
ons_gdhi_components_97_18_raw <-
read_csv("https://raw.githubusercontent.com/NearAndDistant/ruk/main/data_scripts/ons_gdhi_components/ons_gdhi_components_97_18.csv")

```

##### Grabs NUTS1
```{r}

ons_gdhi_NUTS1 <-
ons_gdhi_components_97_18_raw %>%
  filter(`NUTS level` == "NUTS1") %>% # NUTS1 level is regions
  janitor::clean_names(numerals = "left") %>%
  pivot_longer(cols = starts_with("x") , names_to = "year" , values_to = "value") %>%
  mutate(year = str_remove(year , "x"),
         year = as.numeric(year),
         region_name = str_to_title(region_name)) %>%
  # clean long names
  mutate(region_name = if_else(region_name == "Yorkshire And The Humber", "Yorkshire", region_name)) %>%
  mutate(transaction = if_else(transaction == "Imputed social contributions/Social benefits received" , "Social benefits received", transaction)) %>%
  mutate(transaction = if_else(transaction == "Social contributions/Social benefits paid" , "Social contributions, paid", transaction)) %>%
  # filter out unecessary transactions i.e. totals or balances
  mutate(transaction_code = if_else(transaction == "Primary resources total" , "PRT", transaction_code)) %>% # so we keep this as a flow node
  mutate(value = if_else(transaction == "Gross Disposable Income" , NA_real_, value)) %>% # so we keep this as a flow node
  drop_na(transaction_code) %>% # NAs are just total rows in the ONS Excel file
  filter(year == 2018) %>%
  #filter(region_name == "North East" | region_name == "London") %>%
  select(-year, -nuts_level, -nuts_code, -transaction_code) %>%
  # balancing out financials: as the flow diagram needs to know what is left over after "secondary payments" are mad (taxes etc)
  # we have to calculate their subtraction from Balance of Payments so that Gross Dispo
  pivot_wider(id_cols = c(region_name:transaction), names_from = "transaction", values_from = "value") %>%
  mutate(`Balance of primary incomes` = `Balance of primary incomes` - `Current taxes on income, wealth etc` - `Social contributions, paid` - `Other current transfers, paid`) %>%
  pivot_longer(cols = c(`Operating surplus`:`Gross Disposable Income`), names_to = "transaction" , values_to = "value")

```

##### Adding Group
```{r}
prep_NUTS1 <-
ons_gdhi_NUTS1 %>%
mutate(
group = 
case_when(
transaction == "Operating surplus"                   ~ "Income",
transaction == "Mixed income"                        ~ "Income",
transaction == "Compensation of employees"           ~ "Income",
transaction == "Property income, received"           ~ "Income",
transaction == "Primary resources total"             ~ "Income_Total",
transaction == "Property income, paid"               ~ "Rent",
transaction == "Balance of primary incomes"          ~ "Rent",
transaction == "Social benefits received"            ~ "Benefits",
transaction == "Other current transfers, received"   ~ "Benefits",
transaction == "Current taxes on income, wealth etc" ~ "Taxes",
transaction == "Social contributions, paid"          ~ "Taxes",
transaction == "Other current transfers, paid"       ~ "Taxes",
transaction == "Gross Disposable Income"             ~ "Disposable"),
source = 
case_when(
transaction == "Operating surplus"                   ~ "Operating surplus",
transaction == "Mixed income"                        ~ "Mixed income",
transaction == "Compensation of employees"           ~ "Compensation of employees",
transaction == "Property income, received"           ~ "Property income, received",
transaction == "Primary resources total"             ~ "Primary resources total",
transaction == "Property income, paid"               ~ "Balance of primary incomes",
transaction == "Balance of primary incomes"          ~ "Balance of primary incomes",
transaction == "Social benefits received"            ~ "Social benefits received",
transaction == "Other current transfers, received"   ~ "Other current transfers, received",
transaction == "Current taxes on income, wealth etc" ~ "Balance of primary incomes",
transaction == "Social contributions, paid"          ~ "Balance of primary incomes",
transaction == "Other current transfers, paid"       ~ "Balance of primary incomes",
transaction == "Gross Disposable Income"             ~ "Balance of primary incomes"),
target = 
case_when(
transaction  == "Operating surplus"                   ~ "Primary resources total",
transaction  == "Mixed income"                        ~ "Primary resources total",
transaction  == "Compensation of employees"           ~ "Primary resources total",
transaction  == "Property income, received"           ~ "Primary resources total",
transaction  == "Primary resources total"             ~ "Balance of primary incomes",
transaction  == "Property income, paid"               ~ "Property income, paid",
transaction  == "Balance of primary incomes"          ~ "Gross Disposable Income",
transaction  == "Social benefits received"            ~ "Balance of primary incomes",
transaction  == "Other current transfers, received"   ~ "Balance of primary incomes",
transaction  == "Current taxes on income, wealth etc" ~ "Current taxes on income, wealth etc",
transaction  == "Social contributions, paid"          ~ "Social contributions, paid",
transaction  == "Other current transfers, paid"       ~ "Other current transfers, paid",
transaction  == "Gross Disposable Income"             ~ "Gross Disposable Income")) %>%
select(region_name , group, source , target , value) %>%
group_by(region_name)

# group indices 
prep_NUTS1$id <- paste0(group_indices(prep_NUTS1))

indexed_NUTS1 <-
prep_NUTS1 %>%
  group_by(region_name) %>%
  mutate(id2 = str_pad(7:19, width = 2, pad = "0")) %>%
  mutate(id = paste(id , id2, sep = ".")) %>%
  select(-id2) %>%
  select(id , everything()) %>%
  ungroup() %>%
  arrange(id)


```

##### Adding Regions
```{r}

regions <- 
  tibble(
    id          = indexed_NUTS1$id,
    region_name = indexed_NUTS1$region_name,
    group       = "Region",
    source      = indexed_NUTS1$region_name,
    target      = indexed_NUTS1$source,
    value       = indexed_NUTS1$value) %>%
    group_by(source) %>%
    filter(str_detect(id, ".07|.08|.09|.10|.14|.15"))

# group_indices
regions$id <- group_indices(regions)

# id full
regions <- 
  regions %>% 
  group_by(region_name) %>%   
  mutate(id2 = str_pad(1:6, width = 2, pad = "0")) %>%
  mutate(id = paste(id , id2, sep = ".")) %>%
  select(-id2) %>%
  select(id , everything())

# join
full_nuts1 <-
  rbind(indexed_NUTS1 , regions) %>%
  arrange(id)

```

Great reference on this by NHS-R (Lisa Cummmins), here:
https://www.youtube.com/watch?v=3OvsW8OI1wo

#### Create networkD3 links
```{r}

# Nodes
nodes <- 
  full_nuts1 %>%
  select(source , target) %>%
  pivot_longer(cols = c(source,target), values_to = "table_link") %>%
  select(-name) %>%
  distinct(table_link)

```

#### Create node links
```{r}

networkD3_table <-
  full_nuts1 %>%
  mutate(source_id  = match(source , nodes$table_link)-1) %>%
  mutate(target_id = match(target , nodes$table_link)-1)

```

#### Node colors

"Scotland"          = "Purple"          = "#e2d8f4"       
"North East"        = "Orange"          = "#ffefd9"        
"North West"        = "Blue"            = "#dff3f5"        
"Yorkshire"         = "Brown"           = "#efead7"        
"East Midlands"     = "Yellow"          = "#ffffbf"            
"West Midlands"     = "Olive"           = "#bfc9ad"           
"Wales"             = "Lime"            = "#d1ee70"        
"South West"        = "Pink"            = "#ffc9c9"         
"South East"        = "Grey"            = "#bfc9c7"         
"London"            = "Green"           = "#dff2bd"        
"East Of England"   = "Tangerine"       = "#fcc0a6"              
"Northern Ireland"  = "Clover"          = "#68B374"   

##### Show colors
```{r}

nuts1_palette <- c("#e2d8f4", "#ffefd9", "#dff3f5", "#efead7", "#ffffbf", "#bfc9ad", "#d1ee70", "#ffc9c9", "#bfc9c7", "#dff2bd", "#fcc0a6", "#68B374")

scales::show_col(nuts1_palette)

```

For some reason JavaScript does not take spaces in it's characters indicating colors so use one word colors otherwise it will skip the color and place the next. Use one word, CamelCase or snake_case.

```{r}

networkD3_table <-
networkD3_table %>%
  mutate(
    color_group = case_when(
    region_name == "Scotland"         ~ "Purple"     ,
    region_name == "North East"       ~ "Orange"     ,
    region_name == "North West"       ~ "Blue"       ,
    region_name == "Yorkshire"        ~ "Brown"      ,
    region_name == "East Midlands"    ~ "Yellow"     ,
    region_name == "West Midlands"    ~ "Olive"      ,
    region_name == "Wales"            ~ "Lime"       ,
    region_name == "South West"       ~ "Pink"       ,
    region_name == "South East"       ~ "Grey"       ,
    region_name == "London"           ~ "Green"      ,
    region_name == "East Of England"  ~ "Tangerine"  ,
    region_name == "Northern Ireland" ~ "Clover"))

link_color <- 
JS('d3.scaleOrdinal()
    .domain(["Purple","Orange","Blue","Brown","Yellow","Olive","Lime","Pink","Grey","Green","Tangerine","Clover" ])
    .range(["#e2d8f4","#ffefd9","#dff3f5","#efead7","#ffffbf","#bfc9ad","#d1ee70","#ffc9c9","#bfc9c7","#dff2bd","#fcc0a6","#68B374"])')


```

#### {networkD3}
```{r}
library(networkD3)

nd3_gdhi <- 
list(
  nodes = data.frame(name   =        nodes$table_link,
                     color  =        NA),
  links = data.frame(source =        networkD3_table$source_id,
                     target =        networkD3_table$target_id,
                     value  =        networkD3_table$value,
                     color  =        networkD3_table$color_group))


sankeyNetwork(Links = nd3_gdhi$links, Nodes = nd3_gdhi$nodes , 
              Source = "source", Target = "target", Value = "value", NodeID = "name", NodeGroup = "color",
              units = "£", fontSize = 14, fontFamily = "Arial" , nodeWidth = 30, LinkGroup = "color", colourScale = link_color, 
              width = 1400 , height = 900 ,  sinksRight = FALSE, iterations = 0)
```
