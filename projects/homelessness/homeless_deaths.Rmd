---
title: "Homeless death map"
author: "NearAndDistant"
date: "07/02/2022"
output: html_document
---

```{r}
library(tidyverse)

hld_raw <- readxl::read_xlsx("/Users/patrickcorby/Downloads/homelessdeaths2020registrations.xlsx", sheet = "Table 7", skip = 3)

hld_cln <- 
  hld_raw %>% 
  janitor::clean_names() %>% 
  select(area_code, area_name, x2020_identified_deaths:x2013_identified_deaths) %>%
  pivot_longer(cols = c(x2020_identified_deaths:x2013_identified_deaths), names_to = "year", values_to = "deaths") %>%
  mutate(year = str_remove(year, "_identified_deaths"),
         year = str_remove(year, "x"),
         year = as.numeric(year)) %>%
  mutate(deaths = if_else(deaths == 0, NA_real_, deaths)) %>%
  mutate(label = if_else(deaths == 0, NA_character_, paste0(area_name, " (", deaths, ")")))

# filter
hld_flt <- hld_cln %>% filter(year == 2020)

```

```{r}
# political boundaries
# boundary source: https://osdatahub.os.uk/downloads/open/BoundaryLine
library(sf)
library(rgdal)

# Counties and Unitary Authorities (Northamponshire, Buckinghamshire, Dorset)
lad <- 
  readOGR( 
  dsn     = "/Users/patrickcorby/Documents/Data/Local_Authority_Districts_(May_2021)_UK_BFE_V3", 
  layer   = "LAD_MAY_2021_UK_BFE_V2",
  verbose = FALSE) 

# convert to sf
lad_sf <- 
  st_as_sf(lad) %>% 
  rmapshaper::ms_simplify() %>%
  janitor::clean_names() %>%
  select(area_code = "lad21cd", area_name = "lad21nm", long, lat, geometry)

```

```{r}

# joining for LAD
hld_lad <-
  hld_flt %>%
  left_join(lad_sf, by = "area_code")

```

```{r}

hld_lad %>%
  ggplot(aes(geometry = geometry)) +
  geom_sf(aes(fill = deaths), color = "#b4b3b4") +
  nord::scale_fill_nord(palette = "lumina", na.value = "white", discrete = FALSE) +
  #geom_sf_label(aes(x = long, y = lat, label = label),
  #              color = "grey10", size = 2.5, nudge_x = 50000, nudge_y = 50000,
  #              segment = TRUE, segment.color = "grey80", segment.size = 0.5) +
  labs(fill = "Homless Deaths") +
  coord_sf() +
  theme_void() +
  theme(legend.position = c(0.3,0.69),
        legend.direction = "vertical",
        legend.title.align = c(0.5),
        legend.title = element_text(),
        legend.key.width = unit(0.75, "cm"))

```

######## LEAFLET

```{r}

lad_tf <- spTransform(CRS("+proj=longlat +datum=WGS84 +no_defs"))

hld_lad_shp <- sp::merge(lad_tf, hld_flt, by.x = "LAD21CD" , by.y = "area_code", duplicateGeoms = TRUE)

```

```{r}
library(leaflet)
# http://bboxfinder.com/#0.000000,0.000000,0.000000,0.000000

hld_lad_shp %>%
leaflet(options = leafletOptions(minZoom = 1, maxZoom = 9)) %>% 
  addProviderTiles(provider = "Esri.WorldGrayCanvas") %>%
  setView(lng = -5.16, lat = 55.35, zoom = 6) %>%
  addPolygons(weight    = 1,
              color     = "grey",
              fill      = ~deaths,
              label     = ~label)
  

```

