---
title: "UK Deprivation Table"
author: "NearAndDistant"
date: '2022-06-06'
output: html_document
---

```{r}
dir.create(here::here("uk_deprivation_index"))

# temp file to be used throughout
temp   <- tempfile()

```

# DEPRIVATION DATA

Data from MySociety, here: https://github.com/mysociety/composite_uk_imd
Methodology from, here: https://bmjopen.bmj.com/content/bmjopen/6/11/e012750.full.pdf

The composite labels vary by national dataset, but the key columns in the UK England dataset are:

lsoa                  - The code for the LSOA/Datazone/SOA
original_decile       - the original decile in the four different IMD datasets.
overall_local_score   - the original deprivation score in the four different IMD datasets.
UK_IMD_E_score        - the transformed deprivation score into the combined index. This will be the same as the original for the base country.
E_expanded_decile     - the English deciles, with scores for other nations fitted into the same devisions as the original deciles.
UK_IMD_E_pop_decile   - A new set of deciles for the whole dataset, so that 10% of the population is in each decile (uneven number of areas).
UK_IMD_E_pop_quintile - A new set of quintiles for the whole dataset, so that 20% of the population is in each quintile (uneven number of areas).

The ONS do a subset of this analysis for England and Wales **only**. We want all UK nations (inc. Scotland & N. Ireland), see here:
https://commonslibrary.parliament.uk/research-briefings/cbp-7327/

```{r}
library(tidyverse)

ukdi_raw <- 
  read_csv("https://raw.githubusercontent.com/mysociety/composite_uk_imd/master/uk_index/UK_IMD_E.csv") %>% 
  janitor::clean_names() %>%
  select(nation, lsoa, uk_imd_e_rank, uk_imd_e_score)

```

# CONSTITUENCY POPULATION

### Constituencies:

533 in England
40  in Wales
59  in Scotland
18  in Northern Ireland.

Here we will be using the joined dataset, for this project and filtering to what we need for all 650 constituencies, here:
https://commonslibrary.parliament.uk/constituency-statistics-population-by-age/

# POPULATION ESTIMATES

```{r}
# Constituencies
onsurl <- "https://data.parliament.uk/resources/constituencystatistics/PowerBIData/Demography/Population.xlsx"
temp   <- curl::curl_download(url = onsurl, destfile = temp, quiet = FALSE, mode = "wb")

con_pop_raw <- 
  readxl::read_xlsx(temp, sheet = "Age by year data" , range = "A1:E59151") %>% 
  janitor::clean_names() %>%
  distinct(pcon11cd, .keep_all = TRUE) %>%
  select(con_code = "pcon11cd", con_name = "pcon11nm", pop = "all_ages") %>%
  mutate(weight = pop / sum(pop))

```

```{r}

# SLOAs

# England and Wales
# source: https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimatesnationalstatistics
curl <- "https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2flowersuperoutputareamidyearpopulationestimates%2fmid2020sape23dt2/sape23dt2mid2020lsoasyoaestimatesunformatted.xlsx"
temp   <- curl::curl_download(url = curl, destfile = temp, quiet = FALSE, mode = "wb")

lsoa_pop_eng <- 
  readxl::read_xlsx(temp, sheet = "Mid-2020 Persons", skip = 4) %>% 
  janitor::clean_names() %>%
  distinct(lsoa_code, .keep_all = TRUE) %>%
  select(lsoa_code, pop_est = "all_ages")

# Scotland
# source: https://www.opendata.nhs.scot/dataset/population-estimates/resource/c505f490-c201-44bd-abd1-1bd7a64285ee?inner_span=True
lsoa_pop_scot <- 
  read_csv("uk_deprivation_index/c505f490-c201-44bd-abd1-1bd7a64285ee.csv") %>%
  janitor::clean_names() %>%
  filter(year == 2020) %>%
  distinct(data_zone, .keep_all = TRUE) %>%
  select(lsoa_code = "data_zone", pop_est = "all_ages")

# N. Ireland
# source: https://data.gov.uk/dataset/2135b9bf-eb38-4c81-b614-7b07e8fdfc82/population-estimates-for-super-output-areas-soas-and-former-electoral-wards-northern-ireland/datafile/fc3f91dd-a0c7-488a-9996-bd057a7cfffe/preview
lsoa_pop_nire <-
  read_csv("https://www.opendatani.gov.uk/dataset/2135b9bf-eb38-4c81-b614-7b07e8fdfc82/resource/fc3f91dd-a0c7-488a-9996-bd057a7cfffe/download/super-output-areas-soas-by-gender-and-broad-age-bands-mid-2001-to-mid-2020.csv") %>%
  janitor::clean_names() %>%
  filter(mid_year_ending == 2020 & gender == "All persons" & age_group == "All ages") %>%
  distinct(geo_code, .keep_all = TRUE) %>%
  select(lsoa_code = "geo_code", pop_est = "population_estimate")

```

```{r}

# bind all SLOA dfs together
lsoa_pop_all <- rbind(lsoa_pop_eng, lsoa_pop_scot, lsoa_pop_nire)

```

# MAPPING LSOA TO CONSTITUENCIES

We need to join the deprivation index data - which is in Lower Super Output Areas (LSOA) - to their respective constituencies.

England & Wales data, here: https://geoportal.statistics.gov.uk/search?collection=Dataset&sort=name&tags=all(LUP_WPC)
Scottish data, here: https://statistics.gov.scot/data/data-zone-lookup
N. Ireland data, here: https://www.nisra.gov.uk/support/geography/northern-ireland-small-areas

### LSOAs:

32,844  in England
 1,909  in Wales
 6,976  in Scotland
   890  in Northern Ireland.
   
42,619  Total LSOAs

```{r}

# England - lsoas and constituency geo-areas are removed by degrees from each other. We use Wards to map them across to each other.

## constituencies to wards
con_ward  <- read_csv(here::here("uk_deprivation_index/Ward_to_Westminster_Parliamentary_Constituency_to_Local_Authority_District_to_Upper_Tier_Local_Authority__December_2020__Lookup_in_the_United_Kingdom_V2.csv"))
# there are some missing lsoa to cons which we need to bring in for Leeds (only) from the last year (2019)
con_ward2 <- read_csv(here::here("uk_deprivation_index/Ward_to_Westminster_Parliamentary_Constituency_to_Local_Authority_District_(December_2019)_Lookup_in_the_United_Kingdom.csv"))

## wards to lsoa
ward_lsoa <- read_csv(here::here("uk_deprivation_index/Lower_Layer_Super_Output_Area__2011__to_Ward__2020__Lookup_in_England_and_Wales.csv"))

lsoa_eng  <- 
  ward_lsoa %>% 
  left_join(con_ward, by = "WD20CD") %>% 
  mutate(LSOA11NM = str_sub(LSOA11NM, start = 0, end = str_length(LSOA11NM)-4)) %>%
  distinct(LSOA11CD, .keep_all = TRUE) %>%
  left_join(con_ward2, by = c(WD20CD = "WD19CD")) %>%
  # there have been some changes and some fallouts which we need, we will keep the latest changes and add fallouts
  mutate(check = PCON19CD == PCON20CD) %>%
  mutate(PCON20CD = if_else(is.na(PCON20CD), PCON19CD, PCON20CD), 
         PCON20NM = if_else(is.na(PCON20NM), PCON19NM, PCON20NM)) %>% 
  select(LSOA11CD, LSOA11NM, PCON20CD, PCON20NM)


# Scotland
lsoa_scot <- read_csv("https://scottish-government-files.s3.amazonaws.com/13360f3a-ca68-4f3e-8b7f-caffed8712eb/DataZone2011lookup_2022-05-31.csv")

# N. Ireland
## missing names (codes only, we need names for graphics) so download seperate table to join

# lsoa codes
nisurl <- "https://www.nisra.gov.uk/sites/nisra.gov.uk/files/publications/Look-up%20Tables_0.xlsx"
temp   <- curl::curl_download(url = nisurl, destfile = temp, quiet = FALSE, mode = "wb")

lsoa_nire_cd <- readxl::read_xlsx(temp, sheet = "COA2001") %>% 
  janitor::clean_names() %>%
  distinct(soa2001, .keep_all = TRUE) %>%
  select(soa2001, aa2008)

# lsoa names, source, here: https://data.nicva.org/dataset/geographical-names-and-codes-tables/resource/f072a627-5e70-4647-8b55-e5cdc1ba6b9a
lsoa_nire_nm <- read_csv("https://data.nicva.org/sites/default/files/ni_geography_names_codes_all_types_Mar2017.csv")

# join nire codes to names
lsoa_nire <-
  lsoa_nire_cd %>%
  left_join(lsoa_nire_nm, by = c(soa2001 = "code")) %>%
  rename(soa2001nm = name) %>%
  left_join(lsoa_nire_nm, by = c(aa2008 = "code")) %>%
  rename(aa2008nm = name) %>%
  select(-unit.x, -unit.y, -source.x, -source.y)

```

```{r}
# Joining
ukdi_cons <- 
ukdi_raw %>% 
  # England : 28 missing lsoa-to-pc (sort later)
  left_join(lsoa_eng, by = c(lsoa = "LSOA11CD")) %>%
  select(nation, lsoa, LSOA11NM, PCON20CD, PCON20NM, uk_imd_e_rank, uk_imd_e_score) %>%
  # Scotland
  left_join(lsoa_scot, by = c(lsoa = "DZ2011_Code")) %>%
  mutate(LSOA11NM = if_else(is.na(LSOA11NM), IZ2011_Name, LSOA11NM),
         PCON20CD = if_else(is.na(UKPC_Code), PCON20CD, UKPC_Code),
         PCON20NM = if_else(is.na(UKPC_Name), PCON20NM, UKPC_Name)) %>%
  select(nation, lsoa, LSOA11NM, PCON20CD, PCON20NM, uk_imd_e_rank, uk_imd_e_score) %>%
  # N. Ireland
  left_join(lsoa_nire, by = c(lsoa = "soa2001")) %>%
  mutate(LSOA11NM = if_else(is.na(LSOA11NM), soa2001nm, LSOA11NM),
         PCON20CD = if_else(is.na(PCON20CD), aa2008, PCON20CD),
         PCON20NM = if_else(is.na(PCON20NM), aa2008nm, PCON20NM)) %>%
  select(-aa2008, -aa2008nm, -soa2001nm) %>%
  # add sloa pop
  left_join(lsoa_pop_all, by = c(lsoa = "lsoa_code"))

```

```{r}
# checks no missing values
ukdi_cons %>% anti_join(con_pop_raw, by = c(PCON20CD = "con_code")) %>% count(PCON20CD)
```

```{r}

ukdi_index <- 
ukdi_cons %>%
  # trans sloa pop weight
  group_by(PCON20CD) %>%
  mutate(sloa_weight = pop_est/sum(pop_est)) %>%
  # index weighted by pop for constituency
  mutate(ukdi_weighted = uk_imd_e_score*sloa_weight,
         cons_index    = sum(ukdi_weighted)) %>%
  ungroup() %>%
  arrange(desc(cons_index)) %>%
  group_by(fct_inorder(PCON20CD)) %>%
  mutate(cons_rank     = cur_group_id())

# summary
ukdi_index_summary <- ukdi_index %>% distinct(cons_index, .keep_all = TRUE)

```

```{r}
# checks all constituencies caught
con_pop_raw %>%
  left_join(ukdi_index %>% distinct(PCON20CD), by = c(con_code = "PCON20CD"))
```

# ELECTION DATA

```{r}

# 2021 elections
curl <- "https://commonslibrary.parliament.uk/content/uploads/2022/04/LEH-2021-datafile.xlsx"
temp   <- curl::curl_download(url = curl, destfile = temp, quiet = FALSE, mode = "wb")

election21_raw <- readxl::read_xlsx(temp) %>% janitor::clean_names()

# 2022 elections
curl <- "https://researchbriefings.files.parliament.uk/documents/CBP-9545/CBP9545-detailed-results-for-download.xlsx"
temp   <- curl::curl_download(url = curl, destfile = temp, quiet = FALSE, mode = "wb")

election22_raw <- readxl::read_xlsx(temp, skip = 1) %>% janitor::clean_names() %>%
  select(ons_code, council_name, region, party_control_21 = "control_14", party_control_22 = "control_22")

```

```{r}

election21_raw %>% 
  count(wardname)

```
