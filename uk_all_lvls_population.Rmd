---
title: "uk_all_lvls_population"
author: "NearAndDistant"
date: "12/09/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Region Population

#### Downloading Data from ONS

###### 2001 to 2020
```{r}
library(tidyverse)

# readxl does not currently support downloading from url (as of H2 2021) therefore downloading using temp
temp_ons_01_20 <- tempfile(fileext = ".xls")

download.file(
  url = "https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2fpopulationestimatesforukenglandandwalesscotlandandnorthernireland%2fmid2020/ukpopestimatesmid2020on2021geography.xls",
  destfile = temp_ons_01_20)

```

###### 1991 to 2000
```{r}

temp_ons_91_00 <- tempfile(fileext = ".zip")

download.file(
  url = "https://www.ons.gov.uk/file?uri=%2fpeoplepopulationandcommunity%2fpopulationandmigration%2fpopulationestimates%2fdatasets%2fpopulationestimatesforukenglandandwalesscotlandandnorthernireland%2fmid1991tomid2000/mid-1991-to-mid-2000--local-authority-population-studies.zip",
  destfile = temp_ons_91_00)


# due to the data from 1991 to 2000 being in separate xls files in a zip file, extra step to unzip, extract each year and merge

# {} indicate the dynamic year which glue to stitch together for us
unzip_path <- "mid-{unzip_year}-unformatted-data-file.xls"
sheet      <- "Mid-{unzip_year} Persons"

# create an empty tibble with columns to join later
uk_pop_1991_2000 <- tibble(code = as.character(), 
                           name = as.character())

for(i in 1991:2000){
  
unzip_year <- as.character(i) # changing variable that will be glued to 'unzip path' to extract each year

unzip_read <- 
  readxl::read_xls(unzip(temp_ons_91_00 , files = glue::glue(unzip_path)), 
                   sheet = glue::glue(sheet), range = cellranger::cell_cols("A:C")) %>%
  janitor::clean_names()

names(unzip_read)[3] <- unzip_year # rename "all_ages" for each specific year by the year instead

uk_pop_1991_2000 <- left_join(unzip_read, uk_pop_1991_2000)
}

```



###### Reading in XLS Files
```{r}

uk_pop_2001_to_2020 <- readxl::read_xls(temp_ons, sheet = "MYE4", skip = 7)

```

